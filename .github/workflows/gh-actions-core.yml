name: gh-actions-core

on:
  push:

permissions:
  contents: read

jobs:
    check_secrets_DISCORD_ACCESS_TOKEN:
        runs-on: ubuntu-latest
        env: 
            target: ${{ secrets.DISCORD_ACCESS_TOKEN }}
        steps:
            - uses: actions/checkout@v4
            - name: check is NG
              if: env.target == ''
              run: |
                echo '::error title=secrets.DISCORD_ACCESS_TOKEN is NG::secrets.DISCORD_ACCESS_TOKEN is NG'
                exit 1
            - name: check is OK
              if: env.target != ''
              run: |
                echo '::notice title=secrets.DISCORD_ACCESS_TOKEN is OK::secrets.DISCORD_ACCESS_TOKEN is OK'

    check_secrets_IPINFO_ACCESS_TOKEN:
        runs-on: ubuntu-latest
        env: 
            target: ${{ secrets.IPINFO_ACCESS_TOKEN }}
        steps:
            - uses: actions/checkout@v4
            - name: check is NG
              if: env.target == ''
              run: |
                echo '::error title=secrets.IPINFO_ACCESS_TOKEN is NG::secrets.IPINFO_ACCESS_TOKEN is NG'
                exit 1
            - name: check is OK
              if: env.target != ''
              run: |
                echo '::notice title=secrets.IPINFO_ACCESS_TOKEN is OK::secrets.IPINFO_ACCESS_TOKEN is OK'

    check_secrets_CONOHA_TENANTID:
        runs-on: ubuntu-latest
        env: 
            target: ${{ secrets.CONOHA_TENANTID }}
        steps:
            - uses: actions/checkout@v4
            - name: check is NG
              if: env.target == ''
              run: |
                echo '::error title=secrets.CONOHA_TENANTID is NG::secrets.CONOHA_TENANTID is NG'
                exit 1
            - name: check is OK
              if: env.target != ''
              run: |
                echo '::notice title=secrets.CONOHA_TENANTID is OK::secrets.CONOHA_TENANTID is OK'

    check_secrets_CONOHA_USERNAME:
        runs-on: ubuntu-latest
        env: 
            target: ${{ secrets.CONOHA_USERNAME }}
        steps:
            - uses: actions/checkout@v4
            - name: check is NG
              if: env.target == ''
              run: |
                echo '::error title=secrets.CONOHA_USERNAME is NG::secrets.CONOHA_USERNAME is NG'
                exit 1
            - name: check is OK
              if: env.target != ''
              run: |
                echo '::notice title=secrets.CONOHA_USERNAME is OK::secrets.CONOHA_USERNAME is OK'

    check_secrets_CONOHA_PASSWORD:
        runs-on: ubuntu-latest
        env: 
            target: ${{ secrets.CONOHA_PASSWORD }}
        steps:
            - uses: actions/checkout@v4
            - name: check is NG
              if: env.target == ''
              run: |
                echo '::error title=secrets.CONOHA_PASSWORD is NG::secrets.CONOHA_PASSWORD is NG'
                exit 1
            - name: check is OK
              if: env.target != ''
              run: |
                echo '::notice title=secrets.CONOHA_PASSWORD is OK::secrets.CONOHA_PASSWORD is OK'

    build:
        needs:
            - check_secrets_DISCORD_ACCESS_TOKEN
            - check_secrets_IPINFO_ACCESS_TOKEN
            - check_secrets_CONOHA_TENANTID
            - check_secrets_CONOHA_USERNAME
            - check_secrets_CONOHA_PASSWORD
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - run: docker pull php
            - run: docker pull php:apache
            - working-directory: build-env-gh-actions/
              run: docker compose build
            - working-directory: build-env-gh-actions/
              run: docker compose config
            - working-directory: build-env-gh-actions/
              run: docker compose up -d
            - working-directory: build-env-gh-actions/
              run: |
                docker compose exec \
                    -it gh-actions-core \
                        ls -l /var/www/html
            - run: echo {} | jq > request.json
            - run: cat request.json | jq '. |= .+ {"auth":{}}' | tee request2.json && mv request2.json request.json
            - run: cat request.json | jq '.auth |= .+ {"discord":{}}' | tee request2.json && mv request2.json request.json
            - run: cat request.json | jq '.auth |= .+ {"ipinfo":{}}' | tee request2.json && mv request2.json request.json
            - run: cat request.json | jq '.auth |= .+ {"conoha":{}}' | tee request2.json && mv request2.json request.json
            - run: cat request.json | jq '.auth.discord |= .+ {"access_token":"${{ secrets.DISCORD_ACCESS_TOKEN }}"}' | tee request2.json && mv request2.json request.json
            - run: cat request.json | jq '.auth.ipinfo |= .+ {"access_token":"${{ secrets.IPINFO_ACCESS_TOKEN }}"}' | tee request2.json && mv request2.json request.json
            - run: cat request.json | jq '.auth.conoha |= .+ {"passwordCredentials":{}}' | tee request2.json && mv request2.json request.json
            - run: cat request.json | jq '.auth.conoha.passwordCredentials |= .+ {"username":""}' | tee request2.json && mv request2.json request.json
            - run: cat request.json | jq '.auth.conoha |= .+ {"tenantId":""}' | tee request2.json && mv request2.json request.json
            - run: cat request.json | jq '.auth.conoha.passwordCredentials |= .+ {"password":"${{ secrets.CONOHA_PASSWORD }}"}' | tee request2.json && mv request2.json request.json
            - run: cat request.json | jq
            - working-directory: build-env-gh-actions/
              run: |
                docker compose exec \
                    -it gh-actions-core \
                        curl \
                            -X GET \
                            -H 'Content-Type: application/json' \
                            -d @../request.json \
                            http://gh-actions-core/server/
